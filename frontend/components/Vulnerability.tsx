// components/Vulnerability.tsx
"use client";

import * as React from "react";

export type Severity = "low" | "medium" | "high";
export type FixState = "default" | "fixing" | "fixed";

export type VulnerabilityCardData = {
  title: string;
  category?: string;
  message: string;
  severity: Severity;
  filePath: string;
  line: number;
};

export type VulnerabilityCardProps = {
  data: VulnerabilityCardData;
  selected?: boolean;
  onClick?: () => void;
  className?: string;

  /** New: drives the blue/green states */
  state?: FixState;
};

function cx(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(" ");
}

function severityPillClasses(severity: Severity) {
  switch (severity) {
    case "high":
      return "text-[var(--sev-high)]";
    case "medium":
      return "text-[var(--sev-medium)]";
    case "low":
      return "text-[var(--sev-low)]";
  }
}

function severityPillStyle(severity: Severity): React.CSSProperties {
  switch (severity) {
    case "high":
      return { backgroundColor: "rgb(var(--sev-high-rgb) / 0.25)" };
    case "medium":
      return { backgroundColor: "rgb(var(--sev-medium-rgb) / 0.25)" };
    case "low":
      return { backgroundColor: "rgb(var(--sev-low-rgb) / 0.25)" };
  }
}

function severityLabel(severity: Severity) {
  switch (severity) {
    case "high":
      return "High";
    case "medium":
      return "Medium";
    case "low":
      return "Low";
  }
}

function WarningIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" className="opacity-95" fill="none" aria-hidden="true">
      <path
        d="M10.29 3.86 2.89 16.66A2 2 0 0 0 4.6 20h14.8a2 2 0 0 0 1.71-3.34l-7.4-12.8a2 2 0 0 0-3.42 0Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
      <path d="M12 9v4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M12 17h.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </svg>
  );
}

function WrenchIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M14.7 6.3a5 5 0 0 0-6.7 6.7l-5.1 5.1a2 2 0 0 0 2.8 2.8l5.1-5.1a5 5 0 0 0 6.7-6.7l-2.3 2.3-2.2-.6-.6-2.2 2.3-2.3Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

function CheckIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M20 12a8 8 0 1 1-16 0 8 8 0 0 1 16 0Z"
        stroke="currentColor"
        strokeWidth="2"
      />
      <path
        d="m8.5 12.2 2.2 2.2 4.8-5"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

function statusBorderClasses(state: FixState, selected: boolean) {
  // keep the same sizing/opacity/margins, only swap “plain colour”
  if (state === "fixing") {
    return cx(
      "border-[var(--blue)]",
      selected ? "bg-[rgb(var(--foreground-rgb)/0.12)]" : "bg-[rgb(var(--foreground-rgb)/0.03)]",
      "hover:bg-[rgb(var(--foreground-rgb)/0.05)] hover:border-[var(--blue)]"
    );
  }
  if (state === "fixed") {
    return cx(
      "border-[#4CF177]",
      selected ? "bg-[rgb(var(--foreground-rgb)/0.12)]" : "bg-[rgb(var(--foreground-rgb)/0.03)]",
      "hover:bg-[rgb(var(--foreground-rgb)/0.05)] hover:border-[#4CF177]"
    );
  }

  // default behavior
  return selected
    ? "border-[rgb(var(--foreground-rgb)/0.60)] bg-[rgb(var(--foreground-rgb)/0.12)]"
    : "border-[rgb(var(--foreground-rgb)/0.30)] bg-[rgb(var(--foreground-rgb)/0.03)] hover:bg-[rgb(var(--foreground-rgb)/0.05)] hover:border-[rgb(var(--foreground-rgb)/0.45)]";
}

function statusBorderStyle(state: FixState, selected: boolean): React.CSSProperties {
  if (state === "fixing") {
    return {
      backgroundColor: selected 
        ? "rgb(var(--foreground-rgb) / 0.12)" 
        : "rgb(var(--foreground-rgb) / 0.03)",
    };
  }
  if (state === "fixed") {
    return {
      backgroundColor: selected 
        ? "rgb(var(--foreground-rgb) / 0.12)" 
        : "rgb(var(--foreground-rgb) / 0.03)",
    };
  }

  // default behavior
  return {
    borderColor: selected 
      ? "rgb(var(--foreground-rgb) / 0.60)" 
      : "rgb(var(--foreground-rgb) / 0.30)",
    backgroundColor: selected 
      ? "rgb(var(--foreground-rgb) / 0.12)" 
      : "rgb(var(--foreground-rgb) / 0.03)",
  };
}

export function VulnerabilityCard({
  data,
  selected = false,
  onClick,
  className,
  state = "default",
}: VulnerabilityCardProps) {
  return (
    <button
      type="button"
      onClick={onClick}
      aria-pressed={selected}
      className={cx(
        "w-full text-left border transition",
        "px-6 py-4",
        "focus:outline-none focus-visible:ring-2",
        statusBorderClasses(state, selected),
        className
      )}
      style={{
        ...statusBorderStyle(state, selected),
        ...(state === "default" && !selected && {
          "--tw-ring-color": "rgb(var(--blue-rgb) / 0.50)",
        } as React.CSSProperties),
      }}
    >
      <div className="space-y-3">
        {/* Title */}
        <div className="leading-tight">
          <div className="text-1 text-[var(--gray)]">
            {data.title}
            {data.category ? <span>{" "}({data.category})</span> : null}
          </div>
        </div>

        {/* State pill / Severity pill */}
        {state === "default" ? (
          <div>
            <span
              className={cx(
                "inline-flex items-center gap-2 rounded-full px-4 py-1.5",
                "text-3 italic",
                severityPillClasses(data.severity)
              )}
              style={severityPillStyle(data.severity)}
            >
              <span className="text-current">
                <WarningIcon />
              </span>
              {severityLabel(data.severity)} Severity Vulnerability
            </span>
          </div>
        ) : state === "fixing" ? (
          <div>
            <span
              className={cx(
                "inline-flex items-center gap-2 rounded-full px-4 py-1.5",
                "text-3 italic",
                "text-[var(--blue)]"
              )}
              style={{ backgroundColor: "rgb(var(--blue-rgb) / 0.22)" }}
            >
              <span className="text-current">
                <WrenchIcon />
              </span>
              Fixing in the Background...
            </span>
          </div>
        ) : (
          <div>
            <span
              className={cx(
                "inline-flex items-center gap-2 rounded-full px-4 py-1.5",
                "text-3 italic",
                "bg-[#4CF177]/20 text-[#4CF177]"
              )}
            >
              <span className="text-current">
                <CheckIcon />
              </span>
              Fixed Vulnerability
            </span>
          </div>
        )}

        {/* Summary */}
        <p className="text-3 leading-snug" style={{ color: "rgb(var(--gray-rgb) / 0.60)" }}>{data.message}</p>

        {/* Location */}
        <div className="flex items-center gap-4 text-3 text-[var(--gray)] w-full min-w-0">
          <span className="inline-flex items-center justify-center flex-shrink-0" style={{ color: "rgb(var(--gray-rgb) / 0.90)" }}>
            {/* file icon */}
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M14 2H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8l-5-6Z"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinejoin="round"
              />
              <path d="M14 2v6h6" stroke="currentColor" strokeWidth="2" strokeLinejoin="round" />
              <path
                d="M9 14l-2 2 2 2M15 14l2 2-2 2"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
              />
            </svg>
          </span>
          <div className="flex-1 min-w-0 overflow-hidden">
            <div className="flex items-center gap-1 leading-tight whitespace-nowrap" style={{ direction: "rtl" }}>
              <span className="flex-shrink-0" style={{ direction: "ltr", color: "rgb(var(--gray-rgb) / 0.90)" }}>
                (Line {data.line})
              </span>
              <span 
                className="flex-1 min-w-0 overflow-hidden"
                style={{ 
                  direction: "ltr",
                  textOverflow: "ellipsis",
                  whiteSpace: "nowrap"
                }}
              >
                {data.filePath}
              </span>
            </div>
          </div>
        </div>
      </div>
    </button>
  );
}
