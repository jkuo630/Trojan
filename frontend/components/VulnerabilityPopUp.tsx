// components/VulnerabilityPopUp.tsx
"use client";

import * as React from "react";

export type Severity = "low" | "medium" | "high";
export type FixState = "default" | "fixing" | "fixed";

export type VulnerabilityCardData = {
  title: string;
  category?: string;
  message: string;
  severity: Severity;
  filePath: string;
  line: number;
};

export type VulnerabilityPopUpProps = {
  data: VulnerabilityCardData;

  /** New: drives the blue/green states */
  state?: FixState;

  /** Click Fix (should set state->fixing in parent) */
  onFix?: (data: VulnerabilityCardData) => void;

  /** Go to next vulnerability (parent should increment index and loop) */
  onNext?: () => void;

  className?: string;
};

function cx(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(" ");
}

function severityTextClasses(severity: Severity) {
  switch (severity) {
    case "low":
      return "text-[var(--sev-low)]";
    case "medium":
      return "text-[var(--sev-medium)]";
    case "high":
      return "text-[var(--sev-high)]";
  }
}

function severityLabel(severity: Severity) {
  switch (severity) {
    case "low":
      return "Low";
    case "medium":
      return "Medium";
    case "high":
      return "High";
  }
}

function CautionIcon() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M10.29 3.86 2.89 16.66A2 2 0 0 0 4.6 20h14.8a2 2 0 0 0 1.71-3.34l-7.4-12.8a2 2 0 0 0-3.42 0Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinejoin="round"
      />
      <path d="M12 9v4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M12 17h.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </svg>
  );
}

function WrenchIcon() {
  return (
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M14.7 6.3a5 5 0 0 0-6.7 6.7l-5.1 5.1a2 2 0 0 0 2.8 2.8l5.1-5.1a5 5 0 0 0 6.7-6.7l-2.3 2.3-2.2-.6-.6-2.2 2.3-2.3Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

function CheckIcon() {
  return (
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M20 12a8 8 0 1 1-16 0 8 8 0 0 1 16 0Z" stroke="currentColor" strokeWidth="2" />
      <path
        d="m8.5 12.2 2.2 2.2 4.8-5"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

function barBgClass(state: FixState) {
  if (state === "fixing") return "bg-[var(--blue)]";
  if (state === "fixed") return "bg-[#4CF177]";
  return "bg-[#D9D9D9]";
}

function triangleColorClass(state: FixState) {
  if (state === "fixing") return "border-b-[var(--blue)]";
  if (state === "fixed") return "border-b-[#4CF177]";
  return "border-b-[#D9D9D9]";
}

function bodyBorderClass(state: FixState) {
  if (state === "fixing") return "border-[var(--blue)]";
  if (state === "fixed") return "border-[#4CF177]";
  return "border-[#D9D9D9]";
}

export function VulnerabilityPopUp({
  data,
  state = "default",
  onFix,
  onNext,
  className,
}: VulnerabilityPopUpProps) {
  const statusColor = state === "fixing" ? "text-[var(--blue)]" : state === "fixed" ? "text-[#4CF177]" : "";
  const statusHover = "hover:text-white hover:decoration-white";

  return (
    <section className={cx("w-full border-2", bodyBorderClass(state), className)}>
      {/* Top bar */}
      <div className="relative">
        <div className={cx("h-9 w-full", barBgClass(state))} />

        {/* Center triangle pointer (tip UP, on top of bar) */}
        <div className="absolute left-1/2 top-0 -translate-x-1/2 -translate-y-full" aria-hidden="true">
          <div
            className={cx(
              "h-0 w-0 border-l-[16px] border-r-[16px] border-b-[14px] border-l-transparent border-r-transparent",
              triangleColorClass(state)
            )}
          />
        </div>

        {/* File path (12 bold, #0E141A) */}
        <div className="absolute left-4 top-1/2 -translate-y-1/2">
          <span className="text-[12px] font-bold font-[var(--font-sans)] text-[var(--background)]">
            {data.filePath}
          </span>
        </div>
      </div>

      {/* Body */}
      <div
        className={cx(
          "bg-[rgb(var(--background-rgb)/0.96)]",
          "px-6 pt-4 pb-3"
        )}
      >
        {/* Title */}
        <h3 className="text-[16px] font-bold font-[var(--font-sans)] text-[var(--gray)] leading-tight">
          {data.title}
          {data.category ? <span>{" "}({data.category})</span> : null}
        </h3>

        {/* Severity / Fixing / Fixed line */}
        {state === "default" ? (
          <div className="mt-1.5 flex items-center gap-3">
            <span className={cx("inline-flex items-center", severityTextClasses(data.severity))}>
              <CautionIcon />
            </span>
            <span className={cx("text-[12px] italic font-[var(--font-sans)] leading-tight", severityTextClasses(data.severity))}>
              {severityLabel(data.severity)} Severity Vulnerability
            </span>
          </div>
        ) : state === "fixing" ? (
          <div className="mt-1.5 flex items-center gap-3">
            <span className={cx("inline-flex items-center", statusColor)}>
              <WrenchIcon />
            </span>
            <span className={cx("text-[12px] italic font-[var(--font-sans)] leading-tight", statusColor)}>
              Fixing in the Background...
            </span>
          </div>
        ) : (
          <div className="mt-1.5 flex items-center gap-3">
            <span className={cx("inline-flex items-center", statusColor)}>
              <CheckIcon />
            </span>
            <span className={cx("text-[12px] italic font-[var(--font-sans)] leading-tight", statusColor)}>
              Fixed Vulnerability
            </span>
          </div>
        )}

        {/* Message + line number at end */}
        <p className="mt-2 text-[12px] font-normal font-[var(--font-sans)] text-[var(--gray)] leading-snug">
          {data.message}{" "}
          <span className="text-[rgb(var(--gray-rgb)/0.85)]">(Line {data.line})</span>
        </p>

        {/* Action: Fix (default) OR Go to Next (fixing/fixed) */}
        <div className="mt-3 flex justify-center">
          {state === "default" ? (
            <button
              type="button"
              onClick={() => onFix?.(data)}
              className={cx(
                "group inline-flex items-center gap-2 cursor-pointer",
                "text-[16px] font-bold font-[var(--font-sans)] text-[var(--blue)]",
                "underline underline-offset-4 decoration-2 transition-colors",
                statusHover,
                "focus:outline-none focus-visible:ring-2 focus-visible:ring-[rgb(var(--blue-rgb)/0.55)] focus-visible:ring-offset-2 focus-visible:ring-offset-[rgb(var(--background-rgb))]"
              )}
            >
              <span className={cx("transition-colors", "group-hover:text-white")}>
                <WrenchIcon />
              </span>
              Fix
            </button>
          ) : (
            <button
              type="button"
              onClick={onNext}
              className={cx(
                "cursor-pointer",
                "text-[16px] font-bold font-[var(--font-sans)] underline underline-offset-4 decoration-2 transition-colors",
                state === "fixing" ? "text-[var(--blue)]" : "text-[#4CF177]",
                state === "fixing" ? "decoration-[var(--blue)]" : "decoration-[#4CF177]",
                statusHover,
                "focus:outline-none focus-visible:ring-2 focus-visible:ring-[rgb(var(--blue-rgb)/0.55)] focus-visible:ring-offset-2 focus-visible:ring-offset-[rgb(var(--background-rgb))]"
              )}
            >
              Go to Next Vulnerability &gt;
            </button>
          )}
        </div>
      </div>
    </section>
  );
}
