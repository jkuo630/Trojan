"use client";

import * as React from "react";

export type Severity = "low" | "medium" | "high";

export type VulnerabilityCardData = {
  title: string;
  category?: string;
  message: string;
  severity: Severity;
  filePath: string;
  line: number;
};

export type VulnerabilityPopUpProps = {
  data: VulnerabilityCardData;
  onFix?: (data: VulnerabilityCardData) => void;
  className?: string;
};

function cx(...classes: Array<string | false | null | undefined>) {
  return classes.filter(Boolean).join(" ");
}

function severityTextClasses(severity: Severity) {
  switch (severity) {
    case "low":
      return "text-[var(--sev-low)]";
    case "medium":
      return "text-[var(--sev-medium)]";
    case "high":
      return "text-[var(--sev-high)]";
  }
}

function severityLabel(severity: Severity) {
  switch (severity) {
    case "low":
      return "Low";
    case "medium":
      return "Medium";
    case "high":
      return "High";
  }
}

function CautionIcon() {
  return (
    <svg
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      aria-hidden="true"
    >
      <path
        d="M10.29 3.86 2.89 16.66A2 2 0 0 0 4.6 20h14.8a2 2 0 0 0 1.71-3.34l-7.4-12.8a2 2 0 0 0-3.42 0Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinejoin="round"
      />
      <path
        d="M12 9v4"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
      />
      <path
        d="M12 17h.01"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
      />
    </svg>
  );
}

function WrenchIcon() {
  return (
    <svg
      width="22"
      height="22"
      viewBox="0 0 24 24"
      fill="none"
      aria-hidden="true"
    >
      <path
        d="M14.7 6.3a5 5 0 0 0-6.7 6.7l-5.1 5.1a2 2 0 0 0 2.8 2.8l5.1-5.1a2 2 0 0 0 6.7-6.7l-2.3 2.3-2.2-.6-.6-2.2 2.3-2.3Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

export function VulnerabilityPopUp({
  data,
  onFix,
  className,
}: VulnerabilityPopUpProps) {
  return (
    <section className={cx("w-full", className)}>
      {/* Top bar */}
      <div className="relative">
        <div className="h-9 w-full bg-[#D9D9D9]" />

        {/* Center triangle pointer (tip UP, sitting on top of bar) */}
        <div
          className="absolute left-1/2 top-0 -translate-x-1/2 -translate-y-full"
          aria-hidden="true"
        >
          {/* triangle pointing up */}
          <div className="h-0 w-0 border-l-[16px] border-r-[16px] border-b-[14px] border-l-transparent border-r-transparent border-b-[#D9D9D9]" />
        </div>

        {/* File path (12 bold, #0E141A) */}
        <div className="absolute left-4 top-1/2 -translate-y-1/2">
          <span className="text-[12px] font-bold font-[var(--font-sans)] text-[var(--background)]">
            {data.filePath}
          </span>
        </div>
      </div>

      {/* Body */}
      <div
        className={cx(
          "border border-[rgb(var(--foreground-rgb)/0.30)]",
          "bg-[rgb(var(--background-rgb)/0.96)]",
          "px-6 pt-4 pb-3",
        )}
      >
        {/* Title: 16 bold, #D6D6D6 */}
        <h3 className="text-[16px] font-bold font-[var(--font-sans)] text-[var(--gray)] leading-tight">
          {data.title}
          {data.category ? <span> ({data.category})</span> : null}
        </h3>

        {/* Severity: 12 italic, severity color */}
        <div className="mt-1.5 flex items-center gap-3">
          <span
            className={cx(
              "inline-flex items-center",
              severityTextClasses(data.severity),
            )}
          >
            <CautionIcon />
          </span>
          <span
            className={cx(
              "text-[12px] italic font-[var(--font-sans)] leading-tight",
              severityTextClasses(data.severity),
            )}
          >
            {severityLabel(data.severity)} Severity Vulnerability
          </span>
        </div>

        {/* Message: 12 regular, #D6D6D6; tighter line height */}
        <p className="mt-2 text-[12px] font-normal font-[var(--font-sans)] text-[var(--gray)] leading-snug">
          {data.message}
        </p>

        {/* Fix button: bold 16, #669BCB, underlined + hover turns light gray */}
        <div className="mt-3 flex justify-center">
          <button
            type="button"
            onClick={() => onFix?.(data)}
            className={cx(
              "group inline-flex items-center gap-2",
              "cursor-pointer",
              "text-[16px] font-bold font-[var(--font-sans)] text-[var(--blue)]",
              "underline underline-offset-4 decoration-2",
              "transition-colors",
              // hover -> light gray (#D6D6D6)
              "hover:text-[var(--gray)] hover:decoration-[var(--gray)]",
              "active:scale-[0.98]",
              "focus:outline-none focus-visible:ring-2 focus-visible:ring-[rgb(var(--blue-rgb)/0.55)] focus-visible:ring-offset-2 focus-visible:ring-offset-[rgb(var(--background-rgb))]",
            )}
          >
            <span className="transition-colors group-hover:text-[var(--gray)]">
              <WrenchIcon />
            </span>
            Fix
          </button>
        </div>
      </div>
    </section>
  );
}
